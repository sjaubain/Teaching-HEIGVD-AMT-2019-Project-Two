SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0;
SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0;
SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='TRADITIONAL';

DROP SCHEMA IF EXISTS movies;
CREATE SCHEMA movies;
USE movies;

CREATE TABLE amt_user (
  email VARCHAR(64) NOT NULL,
  PRIMARY KEY(email)
);
  
CREATE TABLE amt_movie (
	movie_id INT NOT NULL,
	title VARCHAR(64),
	description VARCHAR(512),
	director VARCHAR(64),
	PRIMARY KEY(movie_id)
);

CREATE TABLE amt_rating (
	rating_id INT NOT NULL,
	user_id VARCHAR(64),
	movie_id INT,
	rating INT,
	description VARCHAR(512),
	PRIMARY KEY(rating_id),
	CONSTRAINT
	FOREIGN KEY (user_id) REFERENCES amt_user(email),
	FOREIGN KEY (movie_id) REFERENCES amt_movie(movie_id)
);

LOAD DATA LOCAL INFILE '/docker-entrypoint-initdb.d/movies.csv' 
INTO TABLE amt_movie
FIELDS TERMINATED BY ',' 
ENCLOSED BY '"'
LINES TERMINATED BY '\n'
IGNORE 1 ROWS;

SET SQL_MODE=@OLD_SQL_MODE;
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;